<script src="../lib/next.js"></script>
<script>

var concat = next.concat;
var map = next.map;
var concurrency = next.concurrency;
var memoize = next.memoize;

// test tool
var add = function(a, callback) {
  callback(null, a + 1);
};

var mul = function(a, callback) {
  callback(null, a * 2);
};

concat(
  function(callback) {
    console.log('test map');

    map(add)([3, 4], function() {
      console.log(arguments)
    });

    callback();
  },

  function(callback) {
    console.log('test memoize');

    var fn = memoize(function(a, b, callback) {
      console.log('new call with arg:' + a + ', ' + b);
      callback(null, a, b);
    });

    fn(2, {hello: 'world'}, function(err, a, b) {
      console.log('call with arg:' + a + ', ' + b);
    });

    fn(2, {hello: 'world'}, function(err, a, b) {
      console.log('call with arg:' + a + ', ' + b);
    });

    fn(3, {hello: 'world'}, function(err, a, b) {
      console.log('call with arg:' + a + ', ' + b);
    });


    fn(3, 'a', function(err, a, b) {
      console.log('call with arg:' + a + ', ' + b);
    });

    callback();
  },

  function(callback) {
    var TASK_COUNT = 10;
    var LIMIT = 3;

    console.log('test concurrency:LIMIT=' + LIMIT + ', TASK_COUNT=' + TASK_COUNT);

    var fn = concurrency(LIMIT, function(a, callback) {
      console.log('start:' + a);
      setTimeout(function() {
        console.log('end:' + a);
        callback(a);
      }, Math.random() * 3000);
    }, function() {
      console.log('drain');
    });

    var completeNum = 0;
    for (var i = 0; i < TASK_COUNT; i++) {
      fn(i, function(a) {
        completeNum += 1;
      })
    };

    var timer = setInterval(function() {
      if (completeNum === TASK_COUNT) {
        clearInterval(timer);
        callback();
      }
    }, 1000);
  },
  // finish
  function() {
    console.log('All tests completed successfully')
  }
)(function(err) {
  console.log(err);
});






</script>

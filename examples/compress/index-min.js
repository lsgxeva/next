(function(a){if(typeof require!="undefined"){a(require,exports,module);return}if(typeof define!="undefined"){define(a);return}var b={exports:{}};a(null,b.exports,b),window.next=b.exports})(function(a,b,c){var d=[].slice,e=function(){},f=function(a,b,c,d){c(a,b,d)},g=function(a){if(!a.length)return f;var b=a[0],c=g(d.call(a,1));return function(a,e,f,g){if(a){f(a,e);return}return b.apply(null,g.concat(function(a){c(a,e,f,d.call(arguments,1))}))}},h=function(a){return Array.isArray(a)?a:[a]},i=function(a){return a instanceof l?a.fns:Array.isArray(a)?a:[a]},j=function(a){return a instanceof l?a:new l(Array.isArray(a)?a:[a])},k=function(a){return function(b,c,d){if(b){a(b);return}a.apply(null,[null].concat(d))}},l=function(a){this.fns=a,this.doNext=g(a)},m=l.prototype;m.next=function(a){return new l(this.fns.concat(i(a)))},m.prev=function(a){return new l(i(a).concat(this.fns))},m._forEach=function(a,b){var c=!1,d=function(a,d,e){if(c)return;if(a){c=!0,b(a,d);return}b(null,d,e)},e=this.doNext;a.forEach(function(a,b){e(null,b,d,h(a))})},m.resolve=function(){var a=arguments,b=a.length-1;if(a.length<1||typeof a[b]!="function")throw"callback must be specified";this.doNext(null,0,k(a[b]),d.call(a,0,b))},m._resolveAll=function(a,b,c){var d=a.length,e=[],f=function(a,f){d-=1,e[a]=f,d===0&&(b(null,c?e:e.reduce(function(a,b){return a.concat(b)})),e=null)};this._forEach(a,function(a,c,d){a?b(a,c):f(c,d)})},m.reduce=function(a){var b=j(a);return this.next(function(a,c){b._resolveAll(a,c)})},c.exports=function(){return new l(d.call(arguments))}});var fs=require("fs"),path=require("path"),_next=require("../../lib/next.js"),uglify=require("uglify-js"),fileName=process.argv[2],filePath=path.dirname(fileName),outputFileName="index-min.js",rscript=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,run=function(){if(!fileName){console.log("调用的时候请输入文件名，例如:node compress.js js.html");return}_next(function(a,b){fs.readFile(a,"utf-8",b)}).next(function(a,b){var c=[];a.match(rscript).forEach(function(a){var b=a.indexOf('src="');b!==-1&&(a=a.substring(b+5),a=a.substring(0,a.indexOf('"')),a!==outputFileName&&c.push(a))}),b(null,c)}).reduce(function(a,b){console.log("read:"+a),fs.readFile(path.resolve(filePath,a),"utf-8",b)}).next(function(a,b){console.log("compress..."),b(null,uglify(a.join("")))}).next(function(a,b){var c=path.join(filePath,outputFileName);fs.writeFile(c,a,"utf-8",function(a){a?b(a):console.log("write file:"+c+" successfully")})}).resolve(fileName,function(a){console.log(1323),console.log(a)})};run()